<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body {
    text-align: center;
  }

  #game {
      margin: 0 auto;
      width: 800px;
  }
  
  .display {
      position: float;
      height: 20px;
      padding: 15px 32px;
      font-size: 22px;
  }

  .column {
    float: left;
    width: 50%;
  }

  /* Clear floats after the columns */
  .row:after {
    content: "";
    display: table;
    clear: both;
  }

  #winning-color {
      position: float;
      height: 10px;
      width: 10px;
      padding: 20px 20px;
/*      font-size: 22px;*/
  }
  

  button {
      margin-top: 20px;
      border-radius: 5px;
      background-color: #a0a0a0;
      border: none;
      color: black;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      width: 25%;
  }

  button:disabled,
  button[disabled]{
    background-color: #cccccc;
    color: #666666;
  }

</style>
</head>
<body>
  <div id="game">
      <div class="row">
        <div class="column">
          <div id="time-display" class="display">Time Remaining: <span id="time-count"></span></div>
        </div>
        <div class="column">
          <div id="coin-display" class="display">Your Bonus: <span id="coin-count"></span></div>  
        </div>
      </div>
      <div id="wheel">
          <canvas id="roulette" width="400" height="400"></canvas>
      </div>
      <div class="row">
        <div class="column">
          <!-- <button id="bet-button" style="width: 50%">Bet 5 Tokens</button> -->
          <button id="bet-button" style="width: 50%">Spin (25&#162;)</button>
        </div>
        <div class="column">
          <button id="pass-button" style="width: 50%">Skip</button>
          <!-- <button id="pass-button" style="width: 50%">Hide (5&#162;)</button> -->
        </div>
      </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>

    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());

    
    var coinCount = urlSearchParams.has("coinCount") ? parseInt(params.coinCount) : 200;
    var timer = urlSearchParams.has("timer") ? parseInt(params.timer) : 15;
    var color = '#000000';
    // var color = '#6495ED';
    var canvas = document.getElementById('roulette');
    var ctx = canvas.getContext('2d');
    var angle = 0;
    var speed = 0;
    var result = false;
    var prob = .05;
    var sliceAngle = 2 * Math.PI * prob;
    var randomStop = (Math.random() * (2 * Math.PI));
    var results = {};
    var outcomes = Array();
    var paused = false;

    function drawWheel() {
        var radius = canvas.width / 3;
        
        var centerX = canvas.width / 2;
        var centerY = canvas.height / 2;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, angle - sliceAngle - (Math.PI/2), angle - (Math.PI/2));
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = color;
        ctx.fill();

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, angle - (Math.PI/2), angle + 2*Math.PI - sliceAngle - (Math.PI/2));
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = '#C0C0C0';
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(centerX, centerY - radius + 0);
        ctx.lineTo(centerX - 10, centerY - radius - 10);
        ctx.lineTo(centerX + 10, centerY - radius - 10);
        ctx.closePath();
        ctx.fillStyle = "black";
        ctx.fill();
    }



    function updateCoinCount(x) {
        coinCount += x;
        dollars = parseInt(coinCount / 100, 10);
        cents = parseInt(coinCount % 100, 10);
        cents = cents < 10 ? "0" + cents : cents;

        $('#coin-count').html("$" + dollars + "." + cents)  

        // document.getElementById('coin-count').innerText = coinCount;
    }

    function isWin() {
        angleFraction = angle % (2*Math.PI) ;

        if ((angleFraction >= 0) && (angleFraction < sliceAngle)) {
          updateCoinCount(200);
          return true;
        } else {
          return false;
        }
    }

    function spinWheel() {


        if (speed == 0) {
          speed = .3;
          randomStop = (Math.random() * (2 * Math.PI));
        
          // $('button').hide();
          // $('button').prop("disabled",true);
        }

        angle += speed;
        angle %= 2 * Math.PI;

        if (angle > randomStop) {
          randomStop = -1;
          speed -= 0.002;
        }
        
        drawWheel();

        if (speed > 0) {
          // keep spinning
          requestAnimationFrame(spinWheel);  
        } else {
          // stop & test for win
          speed = 0;
          outcomes.push(isWin());
          // $('button').prop("disabled",false);           
        } 
    }    

    setInterval(function () {

      if (!paused) {
        timer -= 1;

        if (timer > 0) {
          minutes = parseInt(timer / 60, 10);
          seconds = parseInt(timer % 60, 10);

          seconds = seconds < 10 ? "0" + seconds : seconds;

          $('#time-count').html(minutes + ":" + seconds)  
        } else {
          if (speed == 0) {
            paused = true;
            results['coinCount'] = coinCount;
            results['outcomes'] = outcomes;
            const message = JSON.stringify({
              message: results,
              type: "complete"
            });
            window.parent.postMessage(message,"*");  
          }
        }
      }

    }, 1000);


    updateCoinCount(0);

    document.getElementById('bet-button').addEventListener('click', function() {
        spinWheel();
        updateCoinCount(-25);
        $('button').prop("disabled",true);
    });

    document.getElementById('pass-button').addEventListener('click', function() {
      $('button').prop("disabled",true);

      $('#bet-button').css("visibility", "hidden");
      $('#roulette').css("visibility", "hidden");

        // // $('#roulette').hide();
        // // $('#bet-button').hide();
        // $('#roulette').css("visibility", "hidden");
        // // $('button').css("visibility", "hidden");
        // $('#bet-button').css("visibility", "hidden");
        // $('#pass-button').prop("disabled",true);
        // // updateCoinCount(-5);
    });

    drawWheel();


    
  </script>
</body>
</html>
